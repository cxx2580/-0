<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>名片管理系统 - 主页</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .container { margin-top: 30px; }
        .card { margin-bottom: 20px; }
    </style>
</head>
<body>
<!-- 导航栏 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="#">名片管理系统</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link active" th:href="@{/card/list}">名片列表</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/card/add}">添加名片</a>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <span th:text="${session.loginUser.uname}"></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" th:href="@{/user/updatePwd}">修改密码</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" th:href="@{/user/logout}">安全退出</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- 名片列表 -->
<div class="container">
    <h3 class="mb-4">我的名片</h3>
    <div class="row">
        <div th:each="card : ${cardList}" class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title" th:text="${card.name}"></h5>
                </div>
                <div class="card-body">
                    <p class="card-text"><strong>电话：</strong><span th:text="${card.telephone}"></span></p>
                    <p class="card-text" th:if="${card.email}"><strong>邮箱：</strong><span th:text="${card.email}"></span></p>
                    <p class="card-text" th:if="${card.company}"><strong>单位：</strong><span th:text="${card.company}"></span></p>
                    <p class="card-text" th:if="${card.post}"><strong>职务：</strong><span th:text="${card.post}"></span></p>
                    <p class="card-text" th:if="${card.address}"><strong>地址：</strong><span th:text="${card.address}"></span></p>
                    <div th:if="${card.logoName}" class="mt-3">
                        <img th:src="@{${card.logoName}}" class="img-thumbnail" style="width: 100px; height: 100px;">
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <a th:href="@{/card/detail(id=${card.id},act='detail')}" class="btn btn-sm btn-info">详情</a>
                    <a th:href="@{/card/detail(id=${card.id},act='update')}" class="btn btn-sm btn-warning">修改</a>
                    <button class="btn btn-sm btn-danger delete-btn" th:data-id="${card.id}">删除</button>
                </div>
            </div>
        </div>
        <div th:if="${#lists.isEmpty(cardList)}" class="col-12 text-center">
            <div class="alert alert-info" role="alert">
                暂无名片数据，<a th:href="@{/card/add}">立即添加</a>
            </div>
        </div>
    </div>
</div>

<!-- 备用 CDN 链接 -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.8/axios.min.js"></script>
<!-- 修改删除按钮的点击事件脚本 -->
<script>
    // 删除名片
    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.onclick = function() {
            const id = this.getAttribute("data-id");
            const _this = this; // 保存按钮引用

            if (confirm("确定要删除该名片吗？")) {
                // 禁用按钮并显示加载状态
                _this.disabled = true;
                _this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 删除中...';

                // 使用POST请求（更符合REST规范）
                // 将params改为data，直接传递JSON对象
                axios.post("/card/delete", { id: id })
                    .then(function(response) {
                        // 保持原逻辑不变
                    }).then(function(response) {
                    if (response.data) {
                        // 删除成功，刷新页面
                        location.reload();
                    } else {
                        alert("删除失败，该名片可能不存在或已被删除");
                        // 恢复按钮状态
                        _this.disabled = false;
                        _this.innerHTML = "删除";
                    }
                }).catch(function(error) {
                    // 捕获网络错误
                    alert("删除失败，网络错误请重试");
                    _this.disabled = false;
                    _this.innerHTML = "删除";
                });
            }
        };
    });
</script>
</body>
</html>